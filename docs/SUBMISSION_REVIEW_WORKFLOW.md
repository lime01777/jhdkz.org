# Workflow подачи и рецензирования

## Обзор

> Система реализует OJS‑подобный процесс: автор создаёт подачу, редактор назначает рецензентов, рецензенты отправляют отзывы, редактор принимает решение.

Основные роли:

| Роль       | Возможности                                                                 |
|-----------|------------------------------------------------------------------------------|
| Автор     | Создание подачи, загрузка файлов, добавление соавторов, отслеживание статуса |
| Редактор  | Просмотр очереди, назначение рецензентов, принятие решений                   |
| Рецензент | Принятие/отказ от рецензии, заполнение формы рецензии                        |
| Админ     | Все права + управление пользователями                                        |

## Шаги подачи (автор)

1. **Создание** (`POST /submissions/create/`)
   - Поля: раздел, название, аннотация, ключевые слова, язык, рукопись.
   - Подача создаётся в статусе `draft`.

2. **Файлы** (`/submissions/<id>/step2/`)
   - Дополнительные материалы (таблицы, рисунки, данные). Необязательно.

3. **Авторы** (`/submissions/<id>/step3/`)
   - Корреспондирующий автор фиксируется автоматически.
   - Поддерживается добавление/удаление соавторов. Валидация предотвращает дубли и двойной выбор корреспондирующего автора.

4. **Метаданные** (`/submissions/<id>/step4/`)
   - Исследовательская область, этика, финансирование, комментарии.

5. **Отправка** (`POST /submissions/<id>/step5/`)
   - Проверка `can_be_submitted()` (название, аннотация, раздел, рукопись, хотя бы один автор).
   - Статус → `submitted`, фиксируется `submitted_at`.

### Состояния подачи

```
draft → submitted → reviewer_assigned → review_completed → revision_requested? → accepted → in_production → scheduled → published
                                     ↘ rejected / declined
```

## Работа редактора

- **Панель**: `/reviews/editor/dashboard/` — агрегирует статистику.
- **Очередь**: `/reviews/editor/queue/` — фильтр по статусам (submitted, reviewing и т.д.).
- **Панель назначения рецензентов**: `/reviews/editor/assignments/`
  - Показаны заявки, которые ждут назначения или находятся на рецензии.
  - Встроенные формы назначения (без выхода со страницы).
  - Список доступных рецензентов и ближайшие дедлайны.
- **Создание выпусков**: `/reviews/editor/issues/create/`
  - Редактор создаёт новый выпуск и выбирает статьи (принятые/опубликованные без выпуска).
  - Выбранные статьи автоматически получают статус «Опубликована» и привязываются к выпуску.
- **Назначение рецензента**: `POST /reviews/editor/submission/<id>/assign-reviewer/`
  - Создаётся `ReviewAssignment`, статус подачи → `reviewer_assigned`.
  - При необходимости задаётся дедлайн (`review_due`).
- **Решение**: `POST /reviews/editor/submission/<id>/decision/`
  - Варианты: accept, revision_minor, revision_major, resubmit, reject, decline.
  - Финальные решения обновляют статус подачи (`accepted`, `rejected`, `revision_requested`).  
  - Рассылаются уведомления (через `submissions.utils`).

## Работа рецензента

1. **Приглашение**: письмо с деталями (если настроен SMTP).
2. **Принять/отклонить**: `POST /reviews/reviewer/assignment/<id>/`
   - При принятии создаётся `Review`, статус `in_progress`.
3. **Форма рецензии**: `POST /reviews/reviewer/review/<id>/`
   - Оценки (1–5), комментарии, рекомендации, файлы.
   - После отправки статус рецензии → `completed`, назначение → `completed`, подача → `review_completed`.

## Уведомления (Email)

- `send_submission_confirmation_email` — автору о получении подачи.
- `send_review_invitation_email` — рецензенту.
- `send_review_completed_email` — редактору о завершении.
- `send_editorial_decision_email` — автору о решении.

> Примечание: отправка выполняется, если настроены SMTP-параметры (`EMAIL_HOST_USER` и др.).

## Тесты

Запуск всех тестов:

```bash
python manage.py test submissions reviews
```

### Основные сценарии

- `SubmissionWorkflowTests.test_full_submission_review_workflow`
  - Автор создаёт подачу, добавляет соавтора, отправляет статью.
  - Редактор назначает рецензента.
  - Рецензент принимает приглашение, заполняет рецензию.
  - Редактор принимает решение (accept).

- `SubmissionWorkflowTests.test_submission_author_form_validation`
  - Проверка, что форма авторов предотвращает дубли и двух корреспондирующих авторов.

- `ReviewModelTests`
  - Проверка методов `ReviewAssignment.is_overdue`, `accept`, `decline`.
  - Проверка `Review.complete_review()`.

## Советы по эксплуатации

- **Назначение редактора**: перед назначением рецензента задайте `assigned_editor`, чтобы он получал уведомления.
- **Чеклист перед отправкой**:
  - Заголовок, аннотация, ключевые слова;
  - Выбран раздел;
  - Загружена рукопись;
  - Добавлены авторы (корреспондирующий и соавторы).
- **Повторная подача / ревизии**: поле `submission_type` и `parent_submission` позволяет связать ревизии с оригинальной подачей.

## Дальнейшие улучшения

- Автоматическое уведомление о просроченных рецензиях (cron/management command).
- Интерфейс редактирования авторов после отправки.
- Поддержка анонимных рецензий (masking author info).
- Интеграция с внешними индексами (CrossRef, ORCID API).

