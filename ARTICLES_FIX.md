# Исправление ArticleDetailView - Только опубликованные статьи

## Выполненные изменения

### 1. ✅ ArticleDetailView (articles/views.py)

**Проблема:** Неопубликованные статьи могли отображаться для всех пользователей.

**Решение:**
- Улучшен метод `get_queryset()` для строгой фильтрации:
  - **Обычные пользователи** (неавторизованные или не-авторы): видят **ТОЛЬКО** опубликованные статьи (`status='published'`)
  - **Авторы**: видят опубликованные статьи + свои статьи в любом статусе
- Улучшен метод `get_object()` с лучшей обработкой ошибок и использованием правильных kwargs
- Добавлены оптимизации запросов через `select_related('issue', 'section')` и `prefetch_related('authors')`

### 2. ✅ URL-паттерны (articles/urls.py)

**Проблема:** Неправильный порядок URL-паттернов мог приводить к конфликтам.

**Решение:**
- Переупорядочены URL-паттерны для правильной обработки:
  1. Специфичные пути (`/search/`, `/create/`, `/author/<id>/`, `/<pk>/download/`)
  2. Детальная страница по slug (`/<slug>/`)
  3. Детальная страница по pk (`/<pk>/`) - fallback

**Порядок важен!** Специфичные пути должны быть перед общими.

### 3. ✅ Модель Article (articles/models.py)

**Проверено:**
- ✅ Метод `get_absolute_url()` правильно использует slug с fallback на pk
- ✅ Метод `save()` автоматически генерирует slug при создании статьи
- ✅ Метод `__str__()` возвращает корректное представление

## Как это работает

### Для обычных пользователей:
```
GET /articles/my-article-slug/
→ ArticleDetailView.get_queryset() → только status='published'
→ 404 если статья не опубликована
→ 200 если статья опубликована
```

### Для авторов:
```
GET /articles/my-article-slug/
→ ArticleDetailView.get_queryset() → published OR authors=current_user
→ 200 если статья опубликована ИЛИ автор статьи
→ 404 в остальных случаях
```

## URL структура

### Приоритет 1: Slug (SEO-friendly)
```
/articles/problemy-mediko-psihologo-pedagogicheskogo-soprovozhdeniya/
```
Используется, если у статьи есть slug.

### Приоритет 2: PK (fallback)
```
/articles/123/
```
Используется, если slug отсутствует (старые записи).

## Тестирование

### Проверьте, что работает:

1. **Опубликованная статья доступна:**
   ```bash
   curl http://127.0.0.1:8000/articles/<slug-опубликованной-статьи>/
   # Должен вернуть 200
   ```

2. **Неопубликованная статья недоступна для обычных пользователей:**
   ```bash
   curl http://127.0.0.1:8000/articles/<slug-неопубликованной-статьи>/
   # Должен вернуть 404
   ```

3. **Автор может видеть свою неопубликованную статью:**
   ```bash
   # Войдите как автор статьи
   curl -H "Cookie: sessionid=..." http://127.0.0.1:8000/articles/<slug-своей-статьи>/
   # Должен вернуть 200
   ```

4. **Список статей показывает только опубликованные:**
   ```bash
   curl http://127.0.0.1:8000/articles/
   # Должен показывать только статьи со status='published'
   ```

## Миграции

Убедитесь, что все миграции применены:

```bash
python manage.py migrate
```

Если поле `section` отсутствует в базе данных, выполните:

```bash
python manage.py makemigrations
python manage.py migrate
```

## Важные замечания

1. **Slug автоматически генерируется** при сохранении статьи (если не указан)
2. **Старые статьи без slug** все еще доступны по `/articles/<pk>/`
3. **Авторы могут видеть свои неопубликованные статьи** для удобства редактирования
4. **Обычные пользователи видят только опубликованные статьи** - это критично для безопасности

## Дополнительные улучшения (опционально)

1. Можно добавить редирект со старого URL на новый:
   ```python
   # В ArticleDetailView
   def get(self, request, *args, **kwargs):
       if 'pk' in kwargs and self.get_object().slug:
           return redirect(self.get_object().get_absolute_url(), permanent=True)
       return super().get(request, *args, **kwargs)
   ```

2. Можно добавить кэширование для часто запрашиваемых статей

3. Можно добавить логирование попыток доступа к неопубликованным статьям

---

**Статус:** ✅ Готово к использованию
**Дата:** 2025-11-07

